{#
 Copyright 2023 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
#}

{%- extends BASE_HTML -%}

{% set main_id = 'homepage' %}
{% set page_id = 'page-homepage' %}

{% block head %}
  {{ super() }}
  <style>
    /* Gemini Chat Interface Styles */
    .gemini-chat-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .chat-header h1 {
      font-size: 1.75rem;
      color: #1a1a2e;
      margin-bottom: 8px;
    }

    .chat-header p {
      color: #666;
      font-size: 0.95rem;
    }

    .api-key-section {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .api-key-section.hidden {
      display: none;
    }

    .api-key-section label {
      font-weight: 500;
      color: #856404;
      white-space: nowrap;
    }

    .api-key-section input {
      flex: 1;
      min-width: 200px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
    }

    .api-key-section button {
      background: #ffc107;
      color: #856404;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    .api-key-section button:hover {
      background: #e0a800;
    }

    .api-key-status {
      width: 100%;
      font-size: 0.85rem;
      color: #856404;
    }

    .api-key-status.success {
      color: #155724;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      margin-bottom: 16px;
      min-height: 300px;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: #4285f4;
      color: white;
    }

    .message.assistant .message-avatar {
      background: #34a853;
      color: white;
    }

    .message-content {
      max-width: 75%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
    }

    .message.user .message-content {
      background: #4285f4;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: white;
      color: #1a1a2e;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .message-content p {
      margin: 0 0 8px 0;
    }

    .message-content p:last-child {
      margin-bottom: 0;
    }

    .message-content pre {
      background: #f1f3f4;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }

    .message-content code {
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.9em;
    }

    .chat-input-area {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 16px;
    }

    .file-upload-area {
      margin-bottom: 12px;
    }

    .file-drop-zone {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
      border-color: #4285f4;
      background: #f0f7ff;
    }

    .file-drop-zone input[type="file"] {
      display: none;
    }

    .file-drop-zone .drop-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .file-drop-zone .drop-text {
      color: #666;
      font-size: 0.9rem;
    }

    .file-drop-zone .drop-text span {
      color: #4285f4;
      font-weight: 500;
    }

    .uploaded-files {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .uploaded-file {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #e8f0fe;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .uploaded-file .file-icon {
      color: #4285f4;
    }

    .uploaded-file .remove-file {
      cursor: pointer;
      color: #666;
      font-size: 16px;
    }

    .uploaded-file .remove-file:hover {
      color: #d93025;
    }

    .chat-input-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .chat-input-wrapper {
      flex: 1;
    }

    #chat-input {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 24px;
      padding: 12px 20px;
      font-size: 1rem;
      resize: none;
      min-height: 48px;
      max-height: 150px;
      line-height: 1.5;
      outline: none;
      transition: border-color 0.2s;
    }

    #chat-input:focus {
      border-color: #4285f4;
    }

    #chat-input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }

    #send-btn {
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    #send-btn:hover:not(:disabled) {
      background: #3367d6;
    }

    #send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #send-btn svg {
      width: 20px;
      height: 20px;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #666;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-8px); }
    }

    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .welcome-message h2 {
      color: #1a1a2e;
      margin-bottom: 12px;
    }

    .welcome-message .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 20px;
    }

    .welcome-message .suggestion {
      background: white;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .welcome-message .suggestion:hover {
      border-color: #4285f4;
      background: #f0f7ff;
    }

    .welcome-message .suggestion:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error-message {
      background: #fce8e6;
      color: #d93025;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    @media (max-width: 768px) {
      .gemini-chat-container {
        padding: 10px;
        height: calc(100vh - 150px);
      }

      .message-content {
        max-width: 85%;
      }

      .chat-header h1 {
        font-size: 1.5rem;
      }

      .api-key-section {
        flex-direction: column;
        align-items: stretch;
      }

      .api-key-section input {
        width: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="gemini-chat-container">
    <div class="chat-header">
      <h1>Document Chat Assistant</h1>
      <p>Upload PDFs and ask questions about your documents powered by Gemini AI</p>
    </div>

    <div class="api-key-section" id="api-key-section">
      <label for="api-key-input">Gemini API Key:</label>
      <input type="password" id="api-key-input" placeholder="Enter your Gemini API key">
      <button id="save-api-key">Save Key</button>
      <div class="api-key-status" id="api-key-status">
        Get your API key from <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>
      </div>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="welcome-message" id="welcome-message">
        <h2>How can I help you today?</h2>
        <p>Enter your Gemini API key above, then upload a PDF document or start a conversation</p>
        <div class="suggestions">
          <button class="suggestion" data-text="What can you help me with?" disabled>What can you help me with?</button>
          <button class="suggestion" data-text="How do I upload a document?" disabled>How do I upload a document?</button>
          <button class="suggestion" data-text="Explain what Data Commons is" disabled>Explain what Data Commons is</button>
        </div>
      </div>
    </div>

    <div class="chat-input-area">
      <div class="file-upload-area">
        <div class="file-drop-zone" id="file-drop-zone">
          <div class="drop-icon">ðŸ“„</div>
          <div class="drop-text">
            Drag & drop PDF files here or <span>browse</span>
          </div>
          <input type="file" id="file-input" accept=".pdf" multiple>
        </div>
        <div class="uploaded-files" id="uploaded-files"></div>
      </div>

      <div class="chat-input-row">
        <div class="chat-input-wrapper">
          <textarea
            id="chat-input"
            placeholder="Enter your API key first..."
            rows="1"
            disabled
          ></textarea>
        </div>
        <button id="send-btn" title="Send message" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // Gemini API Configuration
      const GEMINI_API_BASE = 'https://generativelanguage.googleapis.com/v1beta/models';
      const GEMINI_MODEL = 'gemini-2.0-flash';

      // State
      let apiKey = localStorage.getItem('gemini_api_key') || '';
      let uploadedFiles = [];
      let conversationHistory = [];
      let isProcessing = false;

      // DOM Elements
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const fileInput = document.getElementById('file-input');
      const fileDropZone = document.getElementById('file-drop-zone');
      const uploadedFilesContainer = document.getElementById('uploaded-files');
      const welcomeMessage = document.getElementById('welcome-message');
      const apiKeySection = document.getElementById('api-key-section');
      const apiKeyInput = document.getElementById('api-key-input');
      const saveApiKeyBtn = document.getElementById('save-api-key');
      const apiKeyStatus = document.getElementById('api-key-status');

      // System instruction for the AI
      const systemInstruction = `You are a helpful AI assistant integrated into a Custom Data Commons website.
You can help users understand and analyze documents they upload (PDFs), answer questions about Data Commons,
and provide general assistance. When users upload documents, analyze them thoroughly and provide helpful insights.
Be concise but comprehensive in your responses. Use markdown formatting when helpful.`;

      // Initialize
      function init() {
        // Check for saved API key
        if (apiKey) {
          apiKeyInput.value = apiKey;
          enableChat();
        }

        // Event listeners
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        apiKeyInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') saveApiKey();
        });
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', handleKeyDown);
        chatInput.addEventListener('input', autoResize);
        fileInput.addEventListener('change', handleFileSelect);
        fileDropZone.addEventListener('click', () => fileInput.click());
        fileDropZone.addEventListener('dragover', handleDragOver);
        fileDropZone.addEventListener('dragleave', handleDragLeave);
        fileDropZone.addEventListener('drop', handleDrop);

        // Suggestion buttons
        document.querySelectorAll('.suggestion').forEach(btn => {
          btn.addEventListener('click', () => {
            if (!btn.disabled) {
              chatInput.value = btn.dataset.text;
              sendMessage();
            }
          });
        });
      }

      // API Key management
      function saveApiKey() {
        const key = apiKeyInput.value.trim();
        if (!key) {
          apiKeyStatus.textContent = 'Please enter a valid API key';
          apiKeyStatus.className = 'api-key-status';
          return;
        }

        apiKey = key;
        localStorage.setItem('gemini_api_key', key);
        enableChat();
        apiKeyStatus.textContent = 'API key saved! You can now start chatting.';
        apiKeyStatus.className = 'api-key-status success';

        // Hide the API key section after a delay
        setTimeout(() => {
          apiKeySection.classList.add('hidden');
        }, 2000);
      }

      function enableChat() {
        chatInput.disabled = false;
        chatInput.placeholder = 'Ask a question about your documents...';
        sendBtn.disabled = false;
        document.querySelectorAll('.suggestion').forEach(btn => {
          btn.disabled = false;
        });
      }

      // Auto-resize textarea
      function autoResize() {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 150) + 'px';
      }

      // Handle keyboard shortcuts
      function handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }

      // File handling
      function handleDragOver(e) {
        e.preventDefault();
        fileDropZone.classList.add('drag-over');
      }

      function handleDragLeave(e) {
        e.preventDefault();
        fileDropZone.classList.remove('drag-over');
      }

      function handleDrop(e) {
        e.preventDefault();
        fileDropZone.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
        processFiles(files);
      }

      function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        processFiles(files);
        e.target.value = ''; // Reset input
      }

      async function processFiles(files) {
        for (const file of files) {
          if (file.size > 20 * 1024 * 1024) { // 20MB limit for inline
            showError(`File "${file.name}" is too large. Maximum size is 20MB for inline upload.`);
            continue;
          }

          try {
            const base64 = await fileToBase64(file);
            uploadedFiles.push({
              name: file.name,
              data: base64,
              mimeType: 'application/pdf'
            });
            renderUploadedFiles();
          } catch (err) {
            showError(`Failed to process "${file.name}"`);
          }
        }
      }

      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve(base64);
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      function renderUploadedFiles() {
        uploadedFilesContainer.innerHTML = uploadedFiles.map((file, index) => `
          <div class="uploaded-file">
            <span class="file-icon">ðŸ“„</span>
            <span class="file-name">${escapeHtml(file.name)}</span>
            <span class="remove-file" data-index="${index}">&times;</span>
          </div>
        `).join('');

        // Add remove handlers
        document.querySelectorAll('.remove-file').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            uploadedFiles.splice(index, 1);
            renderUploadedFiles();
          });
        });
      }

      // Send message to Gemini API
      async function sendMessage() {
        const message = chatInput.value.trim();
        if ((!message && uploadedFiles.length === 0) || isProcessing || !apiKey) return;

        // Hide welcome message
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
        }

        // Add user message to UI
        let displayMessage = message;
        if (uploadedFiles.length > 0) {
          const fileNames = uploadedFiles.map(f => f.name).join(', ');
          displayMessage = message ?
            `ðŸ“„ ${fileNames}\n\n${message}` :
            `ðŸ“„ Uploaded: ${fileNames}`;
        }
        addMessage('user', displayMessage);

        // Clear input
        chatInput.value = '';
        autoResize();

        // Show typing indicator
        isProcessing = true;
        sendBtn.disabled = true;
        chatInput.disabled = true;
        const typingEl = showTypingIndicator();

        try {
          // Build contents array for Gemini API
          const contents = [];

          // Add conversation history
          for (const item of conversationHistory) {
            contents.push({
              role: item.role,
              parts: [{ text: item.text }]
            });
          }

          // Build current message parts
          const currentParts = [];

          // Add document if uploaded
          if (uploadedFiles.length > 0) {
            currentParts.push({
              inline_data: {
                mime_type: uploadedFiles[0].mimeType,
                data: uploadedFiles[0].data
              }
            });
          }

          // Add text message
          const userMessage = message || 'Please analyze this document and provide a summary.';
          currentParts.push({ text: userMessage });

          contents.push({ role: 'user', parts: currentParts });

          // Build request payload
          const payload = {
            contents: contents,
            system_instruction: {
              parts: [{ text: systemInstruction }]
            },
            generationConfig: {
              temperature: 1.0,
              topP: 0.95,
              topK: 40
            }
          };

          // Make request to Gemini API
          const response = await fetch(
            `${GEMINI_API_BASE}/${GEMINI_MODEL}:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
            }
          );

          const data = await response.json();

          // Remove typing indicator
          typingEl.remove();

          if (data.error) {
            throw new Error(data.error.message || 'API request failed');
          }

          // Extract text from response
          const candidates = data.candidates || [];
          if (candidates.length > 0) {
            const parts = candidates[0].content?.parts || [];
            if (parts.length > 0) {
              const responseText = parts[0].text || '';

              // Add assistant message
              addMessage('assistant', responseText);

              // Update conversation history
              conversationHistory.push({ role: 'user', text: userMessage });
              conversationHistory.push({ role: 'model', text: responseText });

              // Clear uploaded files after successful processing
              uploadedFiles = [];
              renderUploadedFiles();
            } else {
              showError('No response content from AI');
            }
          } else {
            showError('No response from AI');
          }
        } catch (err) {
          typingEl.remove();
          console.error('Chat error:', err);

          if (err.message.includes('API key')) {
            showError('Invalid API key. Please check your Gemini API key.');
            apiKeySection.classList.remove('hidden');
          } else {
            showError(`Error: ${err.message}`);
          }
        } finally {
          isProcessing = false;
          sendBtn.disabled = false;
          chatInput.disabled = false;
          chatInput.focus();
        }
      }

      // UI helpers
      function addMessage(role, content) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${role}`;

        const avatar = role === 'user' ? 'U' : 'AI';
        const formattedContent = formatMessage(content);

        messageEl.innerHTML = `
          <div class="message-avatar">${avatar}</div>
          <div class="message-content">${formattedContent}</div>
        `;

        chatMessages.appendChild(messageEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function formatMessage(content) {
        // Basic markdown-like formatting
        let formatted = escapeHtml(content);

        // Code blocks
        formatted = formatted.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');

        // Inline code
        formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Bold
        formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

        // Italic
        formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

        // Line breaks
        formatted = formatted.replace(/\n/g, '<br>');

        return formatted;
      }

      function showTypingIndicator() {
        const typingEl = document.createElement('div');
        typingEl.className = 'message assistant';
        typingEl.innerHTML = `
          <div class="message-avatar">AI</div>
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        `;
        chatMessages.appendChild(typingEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return typingEl;
      }

      function showError(message) {
        const errorEl = document.createElement('div');
        errorEl.className = 'error-message';
        errorEl.textContent = message;
        chatMessages.appendChild(errorEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Auto-remove after 10 seconds
        setTimeout(() => errorEl.remove(), 10000);
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Initialize on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
{% endblock %}
