{#
 Copyright 2023 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
#}

{%- extends BASE_HTML -%}

{% set main_id = 'standard-insights' %}
{% set page_id = 'page-standard-insights' %}
{% set title = 'India Export Insights' %}

{% block head %}
{{ super() }}
<script src="https://datacommons.org/datacommons.js"></script>
<!-- Leaflet for custom map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    --saffron: #FF9933;
    --white: #FFFFFF;
    --green: #138808;
    --navy: #003366;
    --chakra-blue: #000080;
  }

  .insights-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .insights-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem;
    background: linear-gradient(135deg, var(--saffron) 0%, var(--green) 100%);
    border-radius: 16px;
    color: white;
  }

  .insights-header h1 {
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }

  .insights-header p {
    font-size: 1.1rem;
    opacity: 0.95;
  }

  .insights-header .badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  /* Highlight Section - Key Stats */
  .highlight-section {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .highlight-card {
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-top: 3px solid var(--navy);
  }

  .highlight-card.saffron {
    border-top-color: var(--saffron);
  }

  .highlight-card.green {
    border-top-color: var(--green);
  }

  /* Charts Grid */
  .insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .insight-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
    min-height: 420px;
    border-top: 4px solid var(--navy);
  }

  .insight-card.saffron-border {
    border-top-color: var(--saffron);
  }

  .insight-card.green-border {
    border-top-color: var(--green);
  }

  .insight-card h3 {
    font-size: 1rem;
    color: var(--navy);
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e9ecef;
    font-weight: 600;
  }

  .full-width-card {
    grid-column: 1 / -1;
  }

  .map-card {
    min-height: 550px;
  }

  .map-card datacommons-map {
    width: 100%;
    height: 480px;
    display: block;
  }

  /* Leaflet map tooltip styling */
  .country-tooltip {
    background: rgba(0, 51, 102, 0.95);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  }

  .country-tooltip strong {
    font-size: 14px;
  }

  .india-tooltip {
    background: rgba(255, 153, 51, 0.95);
    color: #003366;
  }

  .leaflet-container {
    font-family: inherit;
    background: #f8fafc;
  }

  #export-map {
    border: 1px solid #e2e8f0;
  }

  /* Section Headers */
  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid var(--navy);
  }

  .section-header h2 {
    font-size: 1.3rem;
    color: var(--navy);
    margin: 0;
    font-weight: 600;
  }

  .section-header .icon {
    width: 36px;
    height: 36px;
    background: var(--saffron);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
  }

  /* Small Cards Grid for Gauge/Pie */
  .small-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .small-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    padding: 1.25rem;
    min-height: 320px;
  }

  .small-card h3 {
    font-size: 0.95rem;
    color: var(--navy);
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  /* Footer */
  .insights-footer {
    text-align: center;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 12px;
    margin-top: 2rem;
  }

  .insights-footer p {
    margin: 0 0 0.5rem 0;
    color: #666;
    font-size: 0.9rem;
  }

  .insights-footer a {
    color: var(--navy);
    text-decoration: none;
  }

  .insights-footer a:hover {
    text-decoration: underline;
  }

  /* Style datacommons-highlight for dark text */
  .highlight-card datacommons-highlight {
    --dc-highlight-header-color: var(--navy);
    --dc-highlight-value-color: var(--navy);
    --dc-highlight-text-color: #333;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .highlight-section {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 1024px) {
    .small-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .highlight-section {
      grid-template-columns: repeat(2, 1fr);
    }
    .insights-grid {
      grid-template-columns: 1fr;
    }
    .insight-card {
      min-height: 350px;
    }
    .insights-header h1 {
      font-size: 1.6rem;
    }
    .small-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .highlight-section {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="insights-container">
  <!-- Header -->
  <div class="insights-header">
    <h1>India Export Insights Dashboard</h1>
    <p>Commodity-wise and Country-wise Export Data from EIDB</p>
    <span class="badge">Data: 2020-2025 | Source: Ministry of Commerce</span>
  </div>

  <!-- Key Highlights Section -->
  <div class="section-header">
    <div class="icon">₹</div>
    <h2>Key Export Statistics</h2>
  </div>

  <div class="highlight-section">
    <div class="highlight-card">
      <datacommons-highlight
        apiRoot="/"
        header="Petroleum Products"
        place="country/IND"
        variable="Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card saffron">
      <datacommons-highlight
        apiRoot="/"
        header="Electronics"
        place="country/IND"
        variable="Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card green">
      <datacommons-highlight
        apiRoot="/"
        header="Machinery"
        place="country/IND"
        variable="Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card saffron">
      <datacommons-highlight
        apiRoot="/"
        header="Gems & Jewellery"
        place="country/IND"
        variable="Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card green">
      <datacommons-highlight
        apiRoot="/"
        header="Pharmaceuticals"
        place="country/IND"
        variable="Exports_EconomicActivity_PharmaceuticalProducts"
      ></datacommons-highlight>
    </div>
  </div>

  <!-- Time Series Trends -->
  <div class="section-header">
    <div class="icon">~</div>
    <h2>Export Trends Over Time</h2>
  </div>

  <div class="insights-grid">
    <!-- Line Chart: Commodity Export Trends - Full Width -->
    <div class="insight-card full-width-card">
      <h3>Top 5 Export Trends (2020-2025)</h3>
      <datacommons-line
        apiRoot="/"
        header="Export Values Over Time"
        places="country/IND"
        variables="Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones Exports_EconomicActivity_PharmaceuticalProducts"
      ></datacommons-line>
    </div>
  </div>

  <!-- Distribution Section -->
  <div class="section-header">
    <div class="icon">%</div>
    <h2>Export Distribution</h2>
  </div>

  <div class="small-grid">
    <!-- Pie Chart: Export Distribution -->
    <div class="small-card">
      <h3>Top 5 Export Distribution</h3>
      <datacommons-pie
        apiRoot="/"
        header="Top 5 Exports Breakdown"
        subheader="These 5 categories = 22.7% of total exports (₹16.84L Cr of ₹74.07L Cr)"
        place="country/IND"
        variables="Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones Exports_EconomicActivity_PharmaceuticalProducts"
        donut
      ></datacommons-pie>
    </div>

    <!-- Gauge: Petroleum Growth Rate (-22%) -->
    <div class="small-card">
      <h3>Petroleum Growth Rate</h3>
      <datacommons-gauge
        apiRoot="/"
        header="YoY Growth (%)"
        place="country/IND"
        variable="GrowthRate_Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir"
        min="-50"
        max="50"
      ></datacommons-gauge>
    </div>

    <!-- Gauge: Electronics Growth Rate (+31%) -->
    <div class="small-card">
      <h3>Electronics Growth Rate</h3>
      <datacommons-gauge
        apiRoot="/"
        header="YoY Growth (%)"
        place="country/IND"
        variable="GrowthRate_Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof"
        min="-50"
        max="50"
      ></datacommons-gauge>
    </div>

    <!-- Gauge: Machinery Growth Rate (+14%) -->
    <div class="small-card">
      <h3>Machinery Growth Rate</h3>
      <datacommons-gauge
        apiRoot="/"
        header="YoY Growth (%)"
        place="country/IND"
        variable="GrowthRate_Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear"
        min="-50"
        max="50"
      ></datacommons-gauge>
    </div>

    <!-- Gauge: Gems Growth Rate (-7%) -->
    <div class="small-card">
      <h3>Gems & Jewellery Growth Rate</h3>
      <datacommons-gauge
        apiRoot="/"
        header="YoY Growth (%)"
        place="country/IND"
        variable="GrowthRate_Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones"
        min="-50"
        max="50"
      ></datacommons-gauge>
    </div>

    <!-- Gauge: Pharma Growth Rate (+14%) -->
    <div class="small-card">
      <h3>Pharma Growth Rate</h3>
      <datacommons-gauge
        apiRoot="/"
        header="YoY Growth (%)"
        place="country/IND"
        variable="GrowthRate_Exports_EconomicActivity_PharmaceuticalProducts"
        min="-50"
        max="50"
      ></datacommons-gauge>
    </div>
  </div>

  <!-- Top Export Destinations Section -->
  <div class="section-header">
    <div class="icon">T</div>
    <h2>Top Export Destinations</h2>
  </div>

  <div class="insights-grid">
    <!-- World Map: Export Destinations -->
    <div class="insight-card full-width-card map-card">
      <h3>India's Export Destinations Worldwide</h3>
      <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Export values in INR (2025) | Hover over countries for details</p>
      <div id="export-map" style="height: 480px; width: 100%; border-radius: 8px; background: #f0f4f8;"></div>
      <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem; font-size: 0.8rem; color: #666;">
        <span>Export Value:</span>
        <div style="display: flex; align-items: center; gap: 4px;">
          <div style="width: 20px; height: 12px; background: #fee5d9; border: 1px solid #ddd;"></div>
          <span>Low</span>
        </div>
        <div style="background: linear-gradient(to right, #fee5d9, #fcae91, #fb6a4a, #de2d26, #a50f15); width: 120px; height: 12px; border: 1px solid #ddd;"></div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <div style="width: 20px; height: 12px; background: #a50f15; border: 1px solid #ddd;"></div>
          <span>High</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="insights-footer">
    <p>
      Data Source: <a href="https://tradestat.commerce.gov.in/" target="_blank">Export Import Data Bank (EIDB)</a> - Ministry of Commerce & Industry, Government of India
    </p>
    <p>
      <a href="/explore">Search Data</a> |
      <a href="/tools/statvar">Browse Variables</a> |
      <a href="/tools/download">Download Data</a>
    </p>
    <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
      Powered by <a href="https://datacommons.org" target="_blank"><span style="color:#4285F4">G</span><span style="color:#EA4335">o</span><span style="color:#FBBC05">o</span><span style="color:#4285F4">g</span><span style="color:#34A853">l</span><span style="color:#EA4335">e</span></a> <a href="https://datacommons.org" target="_blank">Data Commons</a>
    </p>
  </div>
</div>

<script>
// Convert Billion/Trillion display to Crore (Indian numbering system)
// 1 Billion = 100 Crore, 1 Trillion = 1,00,000 Crore (1 Lakh Crore)
function convertToIndianFormat(text) {
  if (!text) return text;

  // Match patterns like "5.66T", "532B", "2.08T", "10T INR", "8T INR" etc.
  const match = text.match(/([\d.]+)\s*([TBM])\s*(INR)?/i);
  if (!match) return null;

  let value = parseFloat(match[1]);
  const suffix = match[2].toUpperCase();

  // Convert to Lakh Crore
  let lakhCrore;
  if (suffix === 'T') {
    // Trillion to Lakh Crore: 1T = 1 Lakh Crore
    lakhCrore = value;
  } else if (suffix === 'B') {
    // Billion to Lakh Crore: 1B = 0.01 Lakh Crore
    lakhCrore = value / 100;
  } else if (suffix === 'M') {
    // Million to Lakh Crore
    lakhCrore = value / 100000;
  } else {
    return null;
  }

  // Format output
  if (lakhCrore >= 1) {
    return '₹' + lakhCrore.toFixed(2) + ' L Cr';
  } else {
    const crore = lakhCrore * 100000;
    if (crore >= 1000) {
      return '₹' + (crore / 1000).toFixed(1) + 'K Cr';
    }
    return '₹' + crore.toFixed(0) + ' Cr';
  }
}

function convertAllValues() {
  // Convert highlight card values
  const highlights = document.querySelectorAll('datacommons-highlight');
  highlights.forEach(highlight => {
    if (!highlight.shadowRoot) return;

    // Find all text elements that might contain values
    const allElements = highlight.shadowRoot.querySelectorAll('*');
    allElements.forEach(el => {
      if (el.children.length === 0 && el.textContent) {
        const text = el.textContent.trim();
        if (/^\d+\.?\d*[TBM]\s*(INR)?$/i.test(text)) {
          const converted = convertToIndianFormat(text);
          if (converted && !el.dataset.converted) {
            el.textContent = converted;
            el.dataset.converted = 'true';
          }
        }
      }
    });
  });

  // Convert chart axis labels (line, bar charts)
  const charts = document.querySelectorAll('datacommons-line, datacommons-bar');
  charts.forEach(chart => {
    if (!chart.shadowRoot) return;

    // Find SVG text elements (axis labels)
    const textElements = chart.shadowRoot.querySelectorAll('text');
    textElements.forEach(text => {
      const content = text.textContent.trim();
      // Match axis labels like "10T INR", "8T INR", "6T INR"
      if (/^\d+\.?\d*[TBM]\s*INR$/i.test(content)) {
        const converted = convertToIndianFormat(content);
        if (converted && !text.dataset.converted) {
          text.textContent = converted;
          text.dataset.converted = 'true';
        }
      }
    });
  });
}

// Run conversion multiple times as components load
document.addEventListener('DOMContentLoaded', function() {
  // Run at various intervals to catch when components render
  [1000, 2000, 3000, 4000, 5000, 7000, 10000].forEach(delay => {
    setTimeout(convertAllValues, delay);
  });

  // Also use MutationObserver
  const observer = new MutationObserver(() => {
    setTimeout(convertAllValues, 500);
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
});

// Pie Chart Hover Tooltips
const pieChartData = {
  'Exports of mineral fuels mineral oils and products of': { value: 5659552900000, label: 'Petroleum Products' },
  'Exports of electrical machinery and equipment and parts thereof': { value: 3735320900000, label: 'Electronics' },
  'Exports of machinery and mechanical appliances boilers nuclear': { value: 2832594600000, label: 'Machinery' },
  'Exports of natural cultured pearls precious semi precious stones': { value: 2536008800000, label: 'Gems & Jewellery' },
  'Exports of pharmaceutical products': { value: 2081286200000, label: 'Pharmaceuticals' }
};

const totalTop5 = 16844763400000;

function formatINR(value) {
  const crore = value / 10000000;
  if (crore >= 100000) {
    return '₹' + (crore / 100000).toFixed(2) + ' Lakh Cr';
  }
  return '₹' + crore.toLocaleString('en-IN', {maximumFractionDigits: 0}) + ' Cr';
}

function addPieChartTooltips() {
  const pieChart = document.querySelector('datacommons-pie');
  if (!pieChart || !pieChart.shadowRoot) return false;

  const shadowRoot = pieChart.shadowRoot;

  // Look for SVG paths (pie slices) or legend items
  const paths = shadowRoot.querySelectorAll('path');
  const legendItems = shadowRoot.querySelectorAll('.legend-item, [class*="legend"] text, .series-label');

  // Create tooltip element if not exists
  let tooltip = document.getElementById('pie-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'pie-tooltip';
    tooltip.style.cssText = `
      position: fixed;
      background: rgba(0, 51, 102, 0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
      z-index: 10000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 280px;
      line-height: 1.4;
    `;
    document.body.appendChild(tooltip);
  }

  // Try to match paths with data by looking at nearby text or aria labels
  paths.forEach((path, index) => {
    if (path.hasAttribute('data-tooltip-added')) return;

    // Get fill color to potentially match with legend
    const fill = path.getAttribute('fill');

    path.style.cursor = 'pointer';
    path.setAttribute('data-tooltip-added', 'true');

    path.addEventListener('mouseenter', function(e) {
      // Try to find the label from legend or nearby elements
      let label = '';
      let dataKey = '';

      // Look for title element inside path
      const title = path.querySelector('title');
      if (title) {
        label = title.textContent;
      }

      // Try aria-label
      if (!label) {
        label = path.getAttribute('aria-label') || '';
      }

      // Match with our data
      let matchedData = null;
      for (const [key, data] of Object.entries(pieChartData)) {
        if (label.toLowerCase().includes(key.toLowerCase().split(' ').slice(0, 3).join(' '))) {
          matchedData = data;
          dataKey = key;
          break;
        }
      }

      // If no match found, try to use index
      if (!matchedData) {
        const keys = Object.keys(pieChartData);
        if (index < keys.length) {
          dataKey = keys[index];
          matchedData = pieChartData[dataKey];
        }
      }

      if (matchedData) {
        const percentage = ((matchedData.value / totalTop5) * 100).toFixed(1);
        tooltip.innerHTML = `
          <strong>${matchedData.label}</strong><br>
          ${formatINR(matchedData.value)}<br>
          <span style="opacity: 0.8">${percentage}% of Top 5</span>
        `;
        tooltip.style.display = 'block';
      }
    });

    path.addEventListener('mousemove', function(e) {
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
    });

    path.addEventListener('mouseleave', function() {
      tooltip.style.display = 'none';
    });
  });

  // Also add tooltips to legend text items
  const textElements = shadowRoot.querySelectorAll('text');
  textElements.forEach(text => {
    if (text.hasAttribute('data-tooltip-added')) return;

    const content = text.textContent.toLowerCase();
    let matchedData = null;

    for (const [key, data] of Object.entries(pieChartData)) {
      if (content.includes('mineral fuel') || content.includes('petroleum')) {
        matchedData = pieChartData['Exports of mineral fuels mineral oils and products of'];
        break;
      } else if (content.includes('electrical')) {
        matchedData = pieChartData['Exports of electrical machinery and equipment and parts thereof'];
        break;
      } else if (content.includes('mechanical') || content.includes('machinery')) {
        matchedData = pieChartData['Exports of machinery and mechanical appliances boilers nuclear'];
        break;
      } else if (content.includes('pearl') || content.includes('precious')) {
        matchedData = pieChartData['Exports of natural cultured pearls precious semi precious stones'];
        break;
      } else if (content.includes('pharma')) {
        matchedData = pieChartData['Exports of pharmaceutical products'];
        break;
      }
    }

    if (matchedData) {
      text.style.cursor = 'pointer';
      text.setAttribute('data-tooltip-added', 'true');

      text.addEventListener('mouseenter', function(e) {
        const percentage = ((matchedData.value / totalTop5) * 100).toFixed(1);
        tooltip.innerHTML = `
          <strong>${matchedData.label}</strong><br>
          ${formatINR(matchedData.value)}<br>
          <span style="opacity: 0.8">${percentage}% of Top 5</span>
        `;
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY + 15) + 'px';
      });

      text.addEventListener('mousemove', function(e) {
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY + 15) + 'px';
      });

      text.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });
    }
  });

  return paths.length > 0;
}

// Initialize pie chart tooltips with retry
function initPieTooltips() {
  let attempts = 0;
  const maxAttempts = 10;

  const tryAdd = () => {
    attempts++;
    const success = addPieChartTooltips();
    if (!success && attempts < maxAttempts) {
      setTimeout(tryAdd, 1000);
    }
  };

  setTimeout(tryAdd, 2000);
}

document.addEventListener('DOMContentLoaded', initPieTooltips);

// Custom Leaflet World Map for Export Destinations
const exportData = {
  // Top 30 export destinations (excluding India) - values in INR
  'USA': 7329568900000,
  'ARE': 3100500800000,
  'NLD': 1921183800000,
  'GBR': 1230569800000,
  'CHN': 1206165600000,
  'SGP': 1095248800000,
  'SAU': 995042100000,
  'BGD': 972439500000,
  'DEU': 899721600000,
  'AUS': 726114700000,
  'FRA': 672928600000,
  'ITA': 653538400000,
  'ZAF': 630167400000,
  'NPL': 625025100000,
  'MYS': 617489500000,
  'BRA': 572195200000,
  'BEL': 534578200000,
  'JPN': 529103100000,
  'HKG': 513464000000,
  'KOR': 492349400000,
  'MEX': 485933700000,
  'TUR': 483256400000,
  'VNM': 459166400000,
  'IDN': 454085200000,
  'RUS': 412432800000,
  'THA': 407228100000,
  'TZA': 405269800000,
  'ESP': 403165300000,
  'CAN': 357282700000,
  'POL': 295000000000,
  'KEN': 280000000000,
  'LKA': 270000000000,
  'EGY': 250000000000,
  'PHL': 220000000000,
  'NGA': 200000000000,
  'PAK': 180000000000,
  'IRN': 150000000000,
  'IRQ': 140000000000,
  'KWT': 130000000000,
  'QAT': 120000000000,
  'OMN': 110000000000,
  'ISR': 100000000000,
  'CHL': 97641800000,
  'ARG': 86320000000,
  'DZA': 80144300000,
  'PER': 70000000000,
  'COL': 60000000000,
  'NZL': 50000000000,
  'AFG': 26956300000,
  'MMR': 20000000000
};

function formatExportValue(value) {
  const crore = value / 10000000;
  if (crore >= 100000) {
    return '₹' + (crore / 100000).toFixed(2) + ' Lakh Cr';
  } else if (crore >= 1000) {
    return '₹' + (crore / 1000).toFixed(2) + 'K Cr';
  }
  return '₹' + crore.toFixed(0) + ' Cr';
}

function getColor(value) {
  // Color scale based on export value (excluding India's huge value)
  // Max is USA at ~7.3 trillion
  if (!value) return '#f0f0f0';
  if (value > 3000000000000) return '#67000d';
  if (value > 1000000000000) return '#a50f15';
  if (value > 500000000000) return '#de2d26';
  if (value > 200000000000) return '#fb6a4a';
  if (value > 100000000000) return '#fcae91';
  if (value > 50000000000) return '#fee5d9';
  return '#fff5f0';
}

function initExportMap() {
  const mapContainer = document.getElementById('export-map');
  if (!mapContainer) return;

  // Initialize map centered on world view
  const map = L.map('export-map', {
    center: [20, 0],
    zoom: 2,
    minZoom: 1,
    maxZoom: 6,
    scrollWheelZoom: true
  });

  // Add tile layer (light gray base map)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap, &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  // Load world GeoJSON
  fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
    .then(response => response.json())
    .then(data => {
      L.geoJSON(data, {
        style: function(feature) {
          // Try multiple property names for country code
          const countryCode = feature.properties['ISO3166-1-Alpha-3'] ||
                              feature.properties.ISO_A3 ||
                              feature.properties.iso_a3 ||
                              feature.properties.ISO3 || '';
          const value = exportData[countryCode] || 0;

          // Skip India - make it transparent/no fill
          if (countryCode === 'IND') {
            return {
              fillColor: '#FF9933',
              weight: 2,
              opacity: 1,
              color: '#FF9933',
              fillOpacity: 0.4
            };
          }

          return {
            fillColor: getColor(value),
            weight: 1,
            opacity: 1,
            color: '#999',
            fillOpacity: 0.85
          };
        },
        onEachFeature: function(feature, layer) {
          // Try multiple property names
          const countryCode = feature.properties['ISO3166-1-Alpha-3'] ||
                              feature.properties.ISO_A3 ||
                              feature.properties.iso_a3 ||
                              feature.properties.ISO3 || '';
          const countryName = feature.properties.name ||
                              feature.properties.ADMIN ||
                              feature.properties.NAME || 'Unknown';
          const value = exportData[countryCode] || 0;

          // Special tooltip for India
          if (countryCode === 'IND') {
            layer.bindTooltip('<strong>India</strong><br>(Source Country)', {
              permanent: false,
              direction: 'center',
              className: 'country-tooltip india-tooltip'
            });
            return;
          }

          // Create tooltip content
          const tooltipContent = value > 0
            ? `<strong>${countryName}</strong><br>Exports: ${formatExportValue(value)}`
            : `<strong>${countryName}</strong><br>Exports: Data not available`;

          layer.bindTooltip(tooltipContent, {
            permanent: false,
            direction: 'center',
            className: 'country-tooltip'
          });

          // Highlight on hover
          layer.on({
            mouseover: function(e) {
              const layer = e.target;
              if (countryCode !== 'IND') {
                layer.setStyle({
                  weight: 2,
                  color: '#003366',
                  fillOpacity: 0.95
                });
                layer.bringToFront();
              }
            },
            mouseout: function(e) {
              const layer = e.target;
              if (countryCode !== 'IND') {
                layer.setStyle({
                  weight: 1,
                  color: '#999',
                  fillOpacity: 0.85
                });
              }
            }
          });
        }
      }).addTo(map);
    })
    .catch(err => {
      console.error('Error loading GeoJSON:', err);
      mapContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: #666;">Unable to load map data</p>';
    });
}

document.addEventListener('DOMContentLoaded', initExportMap);
</script>
{% endblock %}
