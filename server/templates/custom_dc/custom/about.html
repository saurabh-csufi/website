{#
 Copyright 2023 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
#}

{%- extends BASE_HTML -%}

{% set main_id = 'standard-insights' %}
{% set page_id = 'page-standard-insights' %}
{% set title = 'India Export Insights' %}

{% block head %}
{{ super() }}
<script src="https://datacommons.org/datacommons.js"></script>
<!-- Leaflet for custom map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root {
    /* Google Brand Colors */
    --google-blue: #4285F4;
    --google-red: #EA4335;
    --google-yellow: #FBBC04;
    --google-green: #34A853;
    --google-grey: #3C4043;
    --google-grey-500: #9AA0A6;

    /* Primary UI Colors (using Google palette) */
    --saffron: #FBBC04;
    --white: #FFFFFF;
    --green: #34A853;
    --navy: #174ea6;
    --chakra-blue: #4285F4;
  }

  .insights-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .insights-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem;
    background: linear-gradient(135deg, #174EA6 0%, #4285F4 100%);
    border-radius: 16px;
    color: white;
  }

  .insights-header h1 {
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
  }

  .insights-header p {
    font-size: 1.1rem;
    opacity: 0.95;
  }

  .insights-header .badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  /* Highlight Section - Key Stats */
  .highlight-section {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .highlight-card {
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-top: 3px solid var(--navy);
  }

  .highlight-card.saffron {
    border-top-color: var(--saffron);
  }

  .highlight-card.green {
    border-top-color: var(--green);
  }

  /* Charts Grid */
  .insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .insight-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
    min-height: 420px;
    border-top: 4px solid var(--navy);
  }

  .insight-card.saffron-border {
    border-top-color: var(--saffron);
  }

  .insight-card.green-border {
    border-top-color: var(--green);
  }

  .insight-card h3 {
    font-size: 1rem;
    color: var(--navy);
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e9ecef;
    font-weight: 600;
  }

  .full-width-card {
    grid-column: 1 / -1;
  }

  .map-card {
    min-height: 550px;
  }

  .map-card datacommons-map {
    width: 100%;
    height: 480px;
    display: block;
  }

  /* Leaflet map tooltip styling */
  .country-tooltip {
    background: rgba(0, 51, 102, 0.95);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  }

  .country-tooltip strong {
    font-size: 14px;
  }

  .india-tooltip {
    background: rgba(95, 99, 104, 0.95);
    color: #ffffff;
  }

  .leaflet-container {
    font-family: inherit;
    background: #f8fafc;
  }

  #export-map {
    border: 1px solid #e2e8f0;
  }

  /* Section Headers */
  .section-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid var(--navy);
  }

  .section-header h2 {
    font-size: 1.3rem;
    color: var(--navy);
    margin: 0;
    font-weight: 600;
  }

  .section-header .icon {
    width: 36px;
    height: 36px;
    background: #174ea6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
  }

  /* Small Cards Grid for Gauge/Pie */
  .small-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .small-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    padding: 1.25rem;
    min-height: 320px;
  }

  .small-card h3 {
    font-size: 0.95rem;
    color: var(--navy);
    margin-bottom: 0.75rem;
    font-weight: 600;
  }

  /* Custom Gauge Styles - Clean Design */
  .custom-gauge-container {
    position: relative;
    width: 100%;
    height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding-top: 20px;
  }

  .gauge-canvas-wrapper {
    position: relative;
    width: 180px;
    height: 100px;
  }

  .gauge-canvas {
    display: block;
  }

  .gauge-value {
    text-align: center;
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--google-grey);
    margin-top: 4px;
    line-height: 1;
  }

  .gauge-value.positive {
    color: #34A853;  /* Google Green */
  }

  .gauge-value.negative {
    color: #EA4335;  /* Google Red */
  }

  .gauge-value.positive.small {
    color: #4285F4;  /* Google Blue for small positive */
  }

  .gauge-value.negative.small {
    color: #F9AB00;  /* Orange for small negative */
  }

  .gauge-label {
    font-size: 0.8rem;
    color: var(--google-grey-500);
    margin-top: 6px;
    text-align: center;
  }

  .gauge-range {
    display: flex;
    justify-content: space-between;
    width: 180px;
    font-size: 0.65rem;
    color: var(--google-grey-500);
    margin-top: 2px;
  }

  .gauge-source {
    font-size: 0.75rem;
    color: var(--google-grey-500);
    margin-top: 10px;
  }

  .gauge-source a {
    color: var(--navy);
    text-decoration: none;
  }

  .gauge-source a:hover {
    text-decoration: underline;
  }

  /* Footer */
  .insights-footer {
    text-align: center;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 12px;
    margin-top: 2rem;
  }

  .insights-footer p {
    margin: 0 0 0.5rem 0;
    color: #666;
    font-size: 0.9rem;
  }

  .insights-footer a {
    color: var(--navy);
    text-decoration: none;
  }

  .insights-footer a:hover {
    text-decoration: underline;
  }

  /* Style datacommons-highlight for dark text */
  .highlight-card datacommons-highlight {
    --dc-highlight-header-color: var(--navy);
    --dc-highlight-value-color: var(--navy);
    --dc-highlight-text-color: #333;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .highlight-section {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 1024px) {
    .small-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .highlight-section {
      grid-template-columns: repeat(2, 1fr);
    }
    .insights-grid {
      grid-template-columns: 1fr;
    }
    .insight-card {
      min-height: 350px;
    }
    .insights-header h1 {
      font-size: 1.6rem;
    }
    .small-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .highlight-section {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="insights-container">
  <!-- Header -->
  <div class="insights-header">
    <h1>India Export Insights Dashboard</h1>
    <p>Commodity-wise and Country-wise Export Data from EIDB</p>
    <span class="badge">Data: 2020-2025 | Source: Ministry of Commerce</span>
  </div>

  <!-- Key Highlights Section -->
  <div class="section-header">
    <div class="icon">₹</div>
    <h2>Key Export Statistics</h2>
  </div>

  <div class="highlight-section">
    <div class="highlight-card">
      <datacommons-highlight
        apiRoot="/"
        header="Petroleum Products"
        place="country/IND"
        variable="Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card saffron">
      <datacommons-highlight
        apiRoot="/"
        header="Electronics"
        place="country/IND"
        variable="Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card green">
      <datacommons-highlight
        apiRoot="/"
        header="Machinery"
        place="country/IND"
        variable="Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card saffron">
      <datacommons-highlight
        apiRoot="/"
        header="Gems & Jewellery"
        place="country/IND"
        variable="Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones"
      ></datacommons-highlight>
    </div>
    <div class="highlight-card green">
      <datacommons-highlight
        apiRoot="/"
        header="Pharmaceuticals"
        place="country/IND"
        variable="Exports_EconomicActivity_PharmaceuticalProducts"
      ></datacommons-highlight>
    </div>
  </div>

  <!-- Time Series Trends -->
  <div class="section-header">
    <div class="icon">~</div>
    <h2>Export Trends Over Time</h2>
  </div>

  <div class="insights-grid">
    <!-- Line Chart: Commodity Export Trends - Full Width -->
    <div class="insight-card full-width-card">
      <h3>Top 5 Export Trends (2020-2025)</h3>
      <datacommons-line
        apiRoot="/"
        header="Export Values Over Time"
        places="country/IND"
        variables="Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones Exports_EconomicActivity_PharmaceuticalProducts"
      ></datacommons-line>
    </div>
  </div>

  <!-- Distribution Section -->
  <div class="section-header">
    <div class="icon">%</div>
    <h2>Export Distribution</h2>
  </div>

  <div class="small-grid">
    <!-- Pie Chart: Export Distribution -->
    <div class="small-card">
      <h3>Top 5 Export Distribution</h3>
      <datacommons-pie
        apiRoot="/"
        header="Top 5 Exports Breakdown"
        subheader="These 5 categories = 22.7% of total exports (₹16.84L Cr of ₹74.07L Cr)"
        place="country/IND"
        variables="Exports_EconomicActivity_MineralFuelsMineralOilsAndProductsOfTheir Exports_EconomicActivity_ElectricalMachineryAndEquipmentAndPartsThereof Exports_EconomicActivity_MachineryAndMechanicalAppliancesBoilersNuclear Exports_EconomicActivity_NaturalCulturedPearlsPreciousSemiPreciousStones Exports_EconomicActivity_PharmaceuticalProducts"
        donut
      ></datacommons-pie>
    </div>

    <!-- Gauge: Petroleum Growth Rate (-22%) -->
    <div class="small-card">
      <h3>Petroleum Growth Rate</h3>
      <div class="custom-gauge-container" id="gauge-petroleum" data-value="-22" data-label="Petroleum Products">
        <div class="gauge-canvas-wrapper">
          <canvas class="gauge-canvas" width="180" height="100"></canvas>
        </div>
        <div class="gauge-value">--</div>
        <div class="gauge-label">YoY Growth (%)</div>
        <div class="gauge-range"><span>-100%</span><span>0%</span><span>+100%</span></div>
        <div class="gauge-source">Source: <a href="https://tradestat.commerce.gov.in" target="_blank">tradestat.commerce.gov.in</a></div>
      </div>
    </div>

    <!-- Gauge: Electronics Growth Rate (+31%) -->
    <div class="small-card">
      <h3>Electronics Growth Rate</h3>
      <div class="custom-gauge-container" id="gauge-electronics" data-value="31.1" data-label="Electronics">
        <div class="gauge-canvas-wrapper">
          <canvas class="gauge-canvas" width="180" height="100"></canvas>
        </div>
        <div class="gauge-value">--</div>
        <div class="gauge-label">YoY Growth (%)</div>
        <div class="gauge-range"><span>-100%</span><span>0%</span><span>+100%</span></div>
        <div class="gauge-source">Source: <a href="https://tradestat.commerce.gov.in" target="_blank">tradestat.commerce.gov.in</a></div>
      </div>
    </div>

    <!-- Gauge: Machinery Growth Rate (+14%) -->
    <div class="small-card">
      <h3>Machinery Growth Rate</h3>
      <div class="custom-gauge-container" id="gauge-machinery" data-value="13.8" data-label="Machinery">
        <div class="gauge-canvas-wrapper">
          <canvas class="gauge-canvas" width="180" height="100"></canvas>
        </div>
        <div class="gauge-value">--</div>
        <div class="gauge-label">YoY Growth (%)</div>
        <div class="gauge-range"><span>-100%</span><span>0%</span><span>+100%</span></div>
        <div class="gauge-source">Source: <a href="https://tradestat.commerce.gov.in" target="_blank">tradestat.commerce.gov.in</a></div>
      </div>
    </div>

    <!-- Gauge: Gems Growth Rate (-7%) -->
    <div class="small-card">
      <h3>Gems & Jewellery Growth Rate</h3>
      <div class="custom-gauge-container" id="gauge-gems" data-value="-6.8" data-label="Gems & Jewellery">
        <div class="gauge-canvas-wrapper">
          <canvas class="gauge-canvas" width="180" height="100"></canvas>
        </div>
        <div class="gauge-value">--</div>
        <div class="gauge-label">YoY Growth (%)</div>
        <div class="gauge-range"><span>-100%</span><span>0%</span><span>+100%</span></div>
        <div class="gauge-source">Source: <a href="https://tradestat.commerce.gov.in" target="_blank">tradestat.commerce.gov.in</a></div>
      </div>
    </div>

    <!-- Gauge: Pharma Growth Rate (+14%) -->
    <div class="small-card">
      <h3>Pharma Growth Rate</h3>
      <div class="custom-gauge-container" id="gauge-pharma" data-value="13.7" data-label="Pharmaceuticals">
        <div class="gauge-canvas-wrapper">
          <canvas class="gauge-canvas" width="180" height="100"></canvas>
        </div>
        <div class="gauge-value">--</div>
        <div class="gauge-label">YoY Growth (%)</div>
        <div class="gauge-range"><span>-100%</span><span>0%</span><span>+100%</span></div>
        <div class="gauge-source">Source: <a href="https://tradestat.commerce.gov.in" target="_blank">tradestat.commerce.gov.in</a></div>
      </div>
    </div>
  </div>

  <!-- Top Export Destinations Section -->
  <div class="section-header">
    <div class="icon">T</div>
    <h2>Top Export Destinations</h2>
  </div>

  <div class="insights-grid">
    <!-- World Map: Export Destinations -->
    <div class="insight-card full-width-card map-card">
      <h3>India's Export Destinations Worldwide</h3>
      <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Export values in INR (2025) | Hover over countries for details</p>
      <div id="export-map" style="height: 480px; width: 100%; border-radius: 8px; background: #f0f4f8;"></div>
      <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem; font-size: 0.8rem; color: #666;">
        <span>Export Value:</span>
        <div style="display: flex; align-items: center; gap: 4px;">
          <div style="width: 20px; height: 12px; background: #E8EAED; border: 1px solid #ddd; border-radius: 2px;"></div>
          <span>Low</span>
        </div>
        <div style="background: linear-gradient(to right, #E8EAED, #D2E3FC, #AECBFA, #669DF6, #4285F4, #1967D2, #174EA6); width: 140px; height: 12px; border: 1px solid #ddd; border-radius: 2px;"></div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <div style="width: 20px; height: 12px; background: #174EA6; border: 1px solid #ddd; border-radius: 2px;"></div>
          <span>High</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="insights-footer">
    <p>
      Data Source: <a href="https://tradestat.commerce.gov.in/" target="_blank">Export Import Data Bank (EIDB)</a> - Ministry of Commerce & Industry, Government of India
    </p>
    <p>
      <a href="/explore">Search Data</a> |
      <a href="/tools/statvar">Browse Variables</a> |
      <a href="/tools/download">Download Data</a>
    </p>
    <p style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
      Powered by <a href="https://datacommons.org" target="_blank"><span style="color:#4285F4">G</span><span style="color:#EA4335">o</span><span style="color:#FBBC05">o</span><span style="color:#4285F4">g</span><span style="color:#34A853">l</span><span style="color:#EA4335">e</span></a> <a href="https://datacommons.org" target="_blank">Data Commons</a>
    </p>
  </div>
</div>

<script>
// Convert Billion/Trillion display to Crore (Indian numbering system)
// 1 Billion = 100 Crore, 1 Trillion = 1,00,000 Crore (1 Lakh Crore)
function convertToIndianFormat(text) {
  if (!text) return text;

  // Match patterns like "5.66T", "532B", "2.08T", "10T INR", "8T INR" etc.
  const match = text.match(/([\d.]+)\s*([TBM])\s*(INR)?/i);
  if (!match) return null;

  let value = parseFloat(match[1]);
  const suffix = match[2].toUpperCase();

  // Convert to Lakh Crore
  let lakhCrore;
  if (suffix === 'T') {
    // Trillion to Lakh Crore: 1T = 1 Lakh Crore
    lakhCrore = value;
  } else if (suffix === 'B') {
    // Billion to Lakh Crore: 1B = 0.01 Lakh Crore
    lakhCrore = value / 100;
  } else if (suffix === 'M') {
    // Million to Lakh Crore
    lakhCrore = value / 100000;
  } else {
    return null;
  }

  // Format output
  if (lakhCrore >= 1) {
    return '₹' + lakhCrore.toFixed(2) + ' L Cr';
  } else {
    const crore = lakhCrore * 100000;
    if (crore >= 1000) {
      return '₹' + (crore / 1000).toFixed(1) + 'K Cr';
    }
    return '₹' + crore.toFixed(0) + ' Cr';
  }
}

function convertAllValues() {
  // Convert highlight card values
  const highlights = document.querySelectorAll('datacommons-highlight');
  highlights.forEach(highlight => {
    if (!highlight.shadowRoot) return;

    // Find all text elements that might contain values
    const allElements = highlight.shadowRoot.querySelectorAll('*');
    allElements.forEach(el => {
      if (el.children.length === 0 && el.textContent) {
        const text = el.textContent.trim();
        if (/^\d+\.?\d*[TBM]\s*(INR)?$/i.test(text)) {
          const converted = convertToIndianFormat(text);
          if (converted && !el.dataset.converted) {
            el.textContent = converted;
            el.dataset.converted = 'true';
          }
        }
      }
    });
  });

  // Convert chart axis labels (line, bar charts)
  const charts = document.querySelectorAll('datacommons-line, datacommons-bar');
  charts.forEach(chart => {
    if (!chart.shadowRoot) return;

    // Find SVG text elements (axis labels)
    const textElements = chart.shadowRoot.querySelectorAll('text');
    textElements.forEach(text => {
      const content = text.textContent.trim();
      // Match axis labels like "10T INR", "8T INR", "6T INR"
      if (/^\d+\.?\d*[TBM]\s*INR$/i.test(content)) {
        const converted = convertToIndianFormat(content);
        if (converted && !text.dataset.converted) {
          text.textContent = converted;
          text.dataset.converted = 'true';
        }
      }
    });
  });
}

// Run conversion multiple times as components load
document.addEventListener('DOMContentLoaded', function() {
  // Run at various intervals to catch when components render
  [1000, 2000, 3000, 4000, 5000, 7000, 10000].forEach(delay => {
    setTimeout(convertAllValues, delay);
  });

  // Also use MutationObserver
  const observer = new MutationObserver(() => {
    setTimeout(convertAllValues, 500);
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
});

// Pie Chart Hover Tooltips
const pieChartData = {
  'Exports of mineral fuels mineral oils and products of': { value: 5659552900000, label: 'Petroleum Products' },
  'Exports of electrical machinery and equipment and parts thereof': { value: 3735320900000, label: 'Electronics' },
  'Exports of machinery and mechanical appliances boilers nuclear': { value: 2832594600000, label: 'Machinery' },
  'Exports of natural cultured pearls precious semi precious stones': { value: 2536008800000, label: 'Gems & Jewellery' },
  'Exports of pharmaceutical products': { value: 2081286200000, label: 'Pharmaceuticals' }
};

const totalTop5 = 16844763400000;

function formatINR(value) {
  const crore = value / 10000000;
  if (crore >= 100000) {
    return '₹' + (crore / 100000).toFixed(2) + ' Lakh Cr';
  }
  return '₹' + crore.toLocaleString('en-IN', {maximumFractionDigits: 0}) + ' Cr';
}

function addPieChartTooltips() {
  const pieChart = document.querySelector('datacommons-pie');
  if (!pieChart || !pieChart.shadowRoot) return false;

  const shadowRoot = pieChart.shadowRoot;

  // Look for SVG paths (pie slices) or legend items
  const paths = shadowRoot.querySelectorAll('path');
  const legendItems = shadowRoot.querySelectorAll('.legend-item, [class*="legend"] text, .series-label');

  // Create tooltip element if not exists
  let tooltip = document.getElementById('pie-tooltip');
  if (!tooltip) {
    tooltip = document.createElement('div');
    tooltip.id = 'pie-tooltip';
    tooltip.style.cssText = `
      position: fixed;
      background: rgba(0, 51, 102, 0.95);
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
      z-index: 10000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 280px;
      line-height: 1.4;
    `;
    document.body.appendChild(tooltip);
  }

  // Try to match paths with data by looking at nearby text or aria labels
  paths.forEach((path, index) => {
    if (path.hasAttribute('data-tooltip-added')) return;

    // Get fill color to potentially match with legend
    const fill = path.getAttribute('fill');

    path.style.cursor = 'pointer';
    path.setAttribute('data-tooltip-added', 'true');

    path.addEventListener('mouseenter', function(e) {
      // Try to find the label from legend or nearby elements
      let label = '';
      let dataKey = '';

      // Look for title element inside path
      const title = path.querySelector('title');
      if (title) {
        label = title.textContent;
      }

      // Try aria-label
      if (!label) {
        label = path.getAttribute('aria-label') || '';
      }

      // Match with our data
      let matchedData = null;
      for (const [key, data] of Object.entries(pieChartData)) {
        if (label.toLowerCase().includes(key.toLowerCase().split(' ').slice(0, 3).join(' '))) {
          matchedData = data;
          dataKey = key;
          break;
        }
      }

      // If no match found, try to use index
      if (!matchedData) {
        const keys = Object.keys(pieChartData);
        if (index < keys.length) {
          dataKey = keys[index];
          matchedData = pieChartData[dataKey];
        }
      }

      if (matchedData) {
        const percentage = ((matchedData.value / totalTop5) * 100).toFixed(1);
        tooltip.innerHTML = `
          <strong>${matchedData.label}</strong><br>
          ${formatINR(matchedData.value)}<br>
          <span style="opacity: 0.8">${percentage}% of Top 5</span>
        `;
        tooltip.style.display = 'block';
      }
    });

    path.addEventListener('mousemove', function(e) {
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
    });

    path.addEventListener('mouseleave', function() {
      tooltip.style.display = 'none';
    });
  });

  // Also add tooltips to legend text items
  const textElements = shadowRoot.querySelectorAll('text');
  textElements.forEach(text => {
    if (text.hasAttribute('data-tooltip-added')) return;

    const content = text.textContent.toLowerCase();
    let matchedData = null;

    for (const [key, data] of Object.entries(pieChartData)) {
      if (content.includes('mineral fuel') || content.includes('petroleum')) {
        matchedData = pieChartData['Exports of mineral fuels mineral oils and products of'];
        break;
      } else if (content.includes('electrical')) {
        matchedData = pieChartData['Exports of electrical machinery and equipment and parts thereof'];
        break;
      } else if (content.includes('mechanical') || content.includes('machinery')) {
        matchedData = pieChartData['Exports of machinery and mechanical appliances boilers nuclear'];
        break;
      } else if (content.includes('pearl') || content.includes('precious')) {
        matchedData = pieChartData['Exports of natural cultured pearls precious semi precious stones'];
        break;
      } else if (content.includes('pharma')) {
        matchedData = pieChartData['Exports of pharmaceutical products'];
        break;
      }
    }

    if (matchedData) {
      text.style.cursor = 'pointer';
      text.setAttribute('data-tooltip-added', 'true');

      text.addEventListener('mouseenter', function(e) {
        const percentage = ((matchedData.value / totalTop5) * 100).toFixed(1);
        tooltip.innerHTML = `
          <strong>${matchedData.label}</strong><br>
          ${formatINR(matchedData.value)}<br>
          <span style="opacity: 0.8">${percentage}% of Top 5</span>
        `;
        tooltip.style.display = 'block';
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY + 15) + 'px';
      });

      text.addEventListener('mousemove', function(e) {
        tooltip.style.left = (e.clientX + 15) + 'px';
        tooltip.style.top = (e.clientY + 15) + 'px';
      });

      text.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
      });
    }
  });

  return paths.length > 0;
}

// Initialize pie chart tooltips with retry
function initPieTooltips() {
  let attempts = 0;
  const maxAttempts = 10;

  const tryAdd = () => {
    attempts++;
    const success = addPieChartTooltips();
    if (!success && attempts < maxAttempts) {
      setTimeout(tryAdd, 1000);
    }
  };

  setTimeout(tryAdd, 2000);
}

document.addEventListener('DOMContentLoaded', initPieTooltips);

// Custom Leaflet World Map for Export Destinations
const exportData = {
  // Top 30 export destinations (excluding India) - values in INR
  'USA': 7329568900000,
  'ARE': 3100500800000,
  'NLD': 1921183800000,
  'GBR': 1230569800000,
  'CHN': 1206165600000,
  'SGP': 1095248800000,
  'SAU': 995042100000,
  'BGD': 972439500000,
  'DEU': 899721600000,
  'AUS': 726114700000,
  'FRA': 672928600000,
  'ITA': 653538400000,
  'ZAF': 630167400000,
  'NPL': 625025100000,
  'MYS': 617489500000,
  'BRA': 572195200000,
  'BEL': 534578200000,
  'JPN': 529103100000,
  'HKG': 513464000000,
  'KOR': 492349400000,
  'MEX': 485933700000,
  'TUR': 483256400000,
  'VNM': 459166400000,
  'IDN': 454085200000,
  'RUS': 412432800000,
  'THA': 407228100000,
  'TZA': 405269800000,
  'ESP': 403165300000,
  'CAN': 357282700000,
  'POL': 295000000000,
  'KEN': 280000000000,
  'LKA': 270000000000,
  'EGY': 250000000000,
  'PHL': 220000000000,
  'NGA': 200000000000,
  'PAK': 180000000000,
  'IRN': 150000000000,
  'IRQ': 140000000000,
  'KWT': 130000000000,
  'QAT': 120000000000,
  'OMN': 110000000000,
  'ISR': 100000000000,
  'CHL': 97641800000,
  'ARG': 86320000000,
  'DZA': 80144300000,
  'PER': 70000000000,
  'COL': 60000000000,
  'NZL': 50000000000,
  'AFG': 26956300000,
  'MMR': 20000000000
};

function formatExportValue(value) {
  const crore = value / 10000000;
  if (crore >= 100000) {
    return '₹' + (crore / 100000).toFixed(2) + ' Lakh Cr';
  } else if (crore >= 1000) {
    return '₹' + (crore / 1000).toFixed(2) + 'K Cr';
  }
  return '₹' + crore.toFixed(0) + ' Cr';
}

function getColor(value) {
  // Color scale: shades of blue and gray
  // Darker blue for higher values, lighter blue/gray for lower values
  // Max is USA at ~7.3 trillion
  if (!value) return '#F1F3F4';                    // No data - light grey
  if (value > 3000000000000) return '#174EA6';     // Very high - Dark blue
  if (value > 1000000000000) return '#1967D2';     // High - Blue
  if (value > 500000000000) return '#4285F4';      // Medium-high - Medium blue
  if (value > 200000000000) return '#669DF6';      // Medium - Blue
  if (value > 100000000000) return '#AECBFA';      // Medium-low - Light blue
  if (value > 50000000000) return '#D2E3FC';       // Low - Very light blue
  return '#E8EAED';                                 // Very low - Light grey
}

function initExportMap() {
  const mapContainer = document.getElementById('export-map');
  if (!mapContainer) return;

  // Define world bounds to prevent map repetition
  const worldBounds = L.latLngBounds(
    L.latLng(-85, -180),  // Southwest corner
    L.latLng(85, 180)     // Northeast corner
  );

  // Initialize map centered on world view with bounds to prevent repetition
  const map = L.map('export-map', {
    center: [20, 0],
    zoom: 2,
    minZoom: 2,           // Prevent zooming out too far
    maxZoom: 6,
    scrollWheelZoom: true,
    worldCopyJump: false, // Prevent world copy jumping
    maxBounds: worldBounds,
    maxBoundsViscosity: 1.0  // Strict bounds enforcement
  });

  // Add tile layer (light gray base map) with noWrap to prevent repetition
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap, &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 19,
    noWrap: true,         // Prevent tile wrapping/repetition
    bounds: worldBounds   // Limit tiles to world bounds
  }).addTo(map);

  // Load world GeoJSON
  fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
    .then(response => response.json())
    .then(data => {
      L.geoJSON(data, {
        style: function(feature) {
          // Try multiple property names for country code
          const countryCode = feature.properties['ISO3166-1-Alpha-3'] ||
                              feature.properties.ISO_A3 ||
                              feature.properties.iso_a3 ||
                              feature.properties.ISO3 || '';
          const value = exportData[countryCode] || 0;

          // India (source country) - show as gray
          if (countryCode === 'IND') {
            return {
              fillColor: '#9AA0A6',
              weight: 2,
              opacity: 1,
              color: '#5F6368',
              fillOpacity: 0.6
            };
          }

          return {
            fillColor: getColor(value),
            weight: 1,
            opacity: 1,
            color: '#999',
            fillOpacity: 0.85
          };
        },
        onEachFeature: function(feature, layer) {
          // Try multiple property names
          const countryCode = feature.properties['ISO3166-1-Alpha-3'] ||
                              feature.properties.ISO_A3 ||
                              feature.properties.iso_a3 ||
                              feature.properties.ISO3 || '';
          const countryName = feature.properties.name ||
                              feature.properties.ADMIN ||
                              feature.properties.NAME || 'Unknown';
          const value = exportData[countryCode] || 0;

          // Special tooltip for India
          if (countryCode === 'IND') {
            layer.bindTooltip('<strong>India</strong><br>(Source Country)', {
              permanent: false,
              direction: 'center',
              className: 'country-tooltip india-tooltip'
            });
            return;
          }

          // Create tooltip content
          const tooltipContent = value > 0
            ? `<strong>${countryName}</strong><br>Exports: ${formatExportValue(value)}`
            : `<strong>${countryName}</strong><br>Exports: Data not available`;

          layer.bindTooltip(tooltipContent, {
            permanent: false,
            direction: 'center',
            className: 'country-tooltip'
          });

          // Highlight on hover
          layer.on({
            mouseover: function(e) {
              const layer = e.target;
              if (countryCode !== 'IND') {
                layer.setStyle({
                  weight: 2,
                  color: '#003366',
                  fillOpacity: 0.95
                });
                layer.bringToFront();
              }
            },
            mouseout: function(e) {
              const layer = e.target;
              if (countryCode !== 'IND') {
                layer.setStyle({
                  weight: 1,
                  color: '#999',
                  fillOpacity: 0.85
                });
              }
            }
          });
        }
      }).addTo(map);
    })
    .catch(err => {
      console.error('Error loading GeoJSON:', err);
      mapContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: #666;">Unable to load map data</p>';
    });
}

document.addEventListener('DOMContentLoaded', initExportMap);

// Custom Gauge Chart Rendering - Clean Design
// Range: -100 to +100, with proper proportional fill
// Full gray background, colored fill for percentage only
// Warm colors (red/orange) for negative, cool colors (green/blue) for positive

function drawGauge(container) {
  const canvas = container.querySelector('.gauge-canvas');
  const valueEl = container.querySelector('.gauge-value');
  const value = parseFloat(container.dataset.value) || 0;

  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  const width = canvas.width;   // 180
  const height = canvas.height; // 100

  // Center at bottom of canvas, arc curves upward
  const centerX = width / 2;    // 90
  const centerY = height;       // 100
  const radius = 75;
  const lineWidth = 14;

  // Clear canvas
  ctx.clearRect(0, 0, width, height);

  // === ANGLE REFERENCE ===
  // Canvas angles: 0=RIGHT, π/2=DOWN, π=LEFT, -π/2=UP
  // Our semicircle: LEFT(π) --through TOP(-π/2)-- to RIGHT(0)
  const LEFT = Math.PI;         // π = 3.14159 (left edge)
  const TOP = -Math.PI / 2;     // -π/2 = -1.5708 (top center, the 0% mark)
  const RIGHT = 0;              // 0 (right edge)

  // Normalize value to -100 to +100 range
  const clampedValue = Math.max(-100, Math.min(100, value));
  const absValue = Math.abs(clampedValue);

  // Calculate fill angle: 100% = π/2 radians (90°, half the semicircle)
  const fillAngle = (absValue / 100) * (Math.PI / 2);

  // === STEP 1: Draw gray background arc ===
  // Semicircle from LEFT to RIGHT, going CLOCKWISE (through TOP)
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius, LEFT, RIGHT, false);  // false = clockwise through top
  ctx.strokeStyle = '#E0E0E0';
  ctx.lineWidth = lineWidth;
  ctx.lineCap = 'round';
  ctx.stroke();

  // === STEP 2: Determine fill color ===
  let fillColor = null;
  if (clampedValue < 0) {
    // Warm colors for negative
    if (clampedValue <= -50) fillColor = '#C53929';      // Dark red
    else if (clampedValue <= -20) fillColor = '#EA4335'; // Google Red
    else fillColor = '#F9AB00';                          // Orange
  } else if (clampedValue > 0) {
    // Cool colors for positive
    if (clampedValue >= 50) fillColor = '#1E8E3E';       // Dark green
    else if (clampedValue >= 20) fillColor = '#34A853';  // Google Green
    else fillColor = '#4285F4';                          // Google Blue
  }

  // === STEP 3: Draw colored fill arc ===
  if (clampedValue !== 0 && fillColor) {
    ctx.beginPath();

    if (clampedValue < 0) {
      // NEGATIVE: Fill from TOP toward LEFT
      // From TOP(-π/2) toward LEFT(π), we go COUNTER-CLOCKWISE
      // In angle terms: -π/2 → -π (which wraps to π)
      // So we SUBTRACT from TOP to move toward LEFT
      const startAngle = TOP;
      const endAngle = TOP - fillAngle;  // Goes toward -π (same as π, the left side)
      ctx.arc(centerX, centerY, radius, startAngle, endAngle, true);  // true = CCW toward left
    } else {
      // POSITIVE: Fill from TOP toward RIGHT
      // From TOP(-π/2) toward RIGHT(0), we go CLOCKWISE
      // In angle terms: -π/2 → 0
      // So we ADD to TOP to move toward RIGHT
      const startAngle = TOP;
      const endAngle = TOP + fillAngle;  // Goes toward 0 (the right side)
      ctx.arc(centerX, centerY, radius, startAngle, endAngle, false);  // false = CW toward right
    }

    ctx.strokeStyle = fillColor;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = 'butt';  // Use butt cap so fill starts exactly at 0% line
    ctx.stroke();
  }

  // === STEP 4: Draw center tick mark at 0% (top) ===
  const tickY1 = centerY - radius + lineWidth/2 + 2;
  const tickY2 = centerY - radius - lineWidth/2 - 4;
  ctx.beginPath();
  ctx.moveTo(centerX, tickY1);
  ctx.lineTo(centerX, tickY2);
  ctx.strokeStyle = '#9E9E9E';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.stroke();

  // Update value display with appropriate color class
  const displayValue = value >= 0 ? '+' + value.toFixed(1) + '%' : value.toFixed(1) + '%';
  valueEl.textContent = displayValue;

  // Set color class based on value
  let colorClass = 'gauge-value';
  if (value >= 0) {
    colorClass += ' positive';
    if (value < 20) colorClass += ' small';
  } else {
    colorClass += ' negative';
    if (value > -20) colorClass += ' small';
  }
  valueEl.className = colorClass;
}

function initCustomGauges() {
  const gaugeContainers = document.querySelectorAll('.custom-gauge-container');
  gaugeContainers.forEach(container => {
    drawGauge(container);
  });
}

document.addEventListener('DOMContentLoaded', initCustomGauges);
</script>
{% endblock %}
